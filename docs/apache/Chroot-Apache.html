<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chroot Apache &mdash; Webserver mitigations</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Disable SSI and CGI execution" href="Disable-SSI-and-CGI-execution.html" />
    <link rel="prev" title="Apache" href="README.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Webserver mitigations
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Apache</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="README.html">Apache</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Chroot Apache</a></li>
<li class="toctree-l1"><a class="reference internal" href="Disable-SSI-and-CGI-execution.html">Disable SSI and CGI execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="Disable-directory-listing.html">Disable directory listing</a></li>
<li class="toctree-l1"><a class="reference internal" href="Hide-version-and-OS-identity.html">Hide version and OS identity</a></li>
<li class="toctree-l1"><a class="reference internal" href="Restrict-file-and-directory-access.html">Restrict file and directory access</a></li>
<li class="toctree-l1"><a class="reference internal" href="mod_security.html">Install and use mod_security</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Nginx</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../nginx/README.html">Nginx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nginx/Chroot-Nginx.html">Chroot Nginx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nginx/Disable-SSI-and-CGI-execution.html">Disable SSI and CGI execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nginx/Hide-version-and-OS-identity.html">Hide version and OS identity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nginx/Restrict-file-and-directory-access.html">Restrict file and directory access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nginx/mod_security.html">Install and use mod_security</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">All mitigations</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://tymyrddin.github.io/mitigations/">Overview</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Webserver mitigations</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Chroot Apache</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/docs/apache/Chroot-Apache.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="chroot-apache">
<h1>Chroot Apache<a class="headerlink" href="#chroot-apache" title="Permalink to this heading"></a></h1>
<p>Installing Apache in a <code class="docutils literal notranslate"><span class="pre">chroot</span></code> jail does not make it any more secure in and of itself, but restricts the access of Apache and its child processes to a small subset of the filesystem. It does not prevent a break-in, it contains a potential threat.</p>
<ul class="simple">
<li><p>If Apache is compromised, an intruder will have access only to the files within the jail.</p></li>
<li><p>Potentially dangerous scripts do not have access to the server’s filesystem.</p></li>
<li><p>The web tree is contained in one area that’s easy to back up and move.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">chroot</span></code> environment can be more difficult to set up, especially when running external software such as Perl, PHP, MySQL, or Python.</p></li>
<li><p>Works only if the entire web tree exists on a single filesystem.</p></li>
</ul>
<p>The steps are similar to the ones used for creating a simple jail with bash and ls, that is, building a “virtual root” containing every file the program may need. For Apache it is just slightly more complex: Libraries (C, libssl, libm, libmysqlclient), resolver configuration files (<code class="docutils literal notranslate"><span class="pre">/etc/nsswitch.conf</span></code>, <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code>), user files (<code class="docutils literal notranslate"><span class="pre">/etc/passwd</span></code>, <code class="docutils literal notranslate"><span class="pre">/etc/group</span></code>), a separate directory for log files, additional modules needed by the program (for Apache: mod_php and other modules). And then run the program, read the error message(s), copy the missing file, start over. Puzzle mania fun.</p>
<p>Apache runs as <code class="docutils literal notranslate"><span class="pre">nobody</span></code> by default. User <code class="docutils literal notranslate"><span class="pre">nobody</span></code> may be used by many processes, and if it is compromised an intruder will gain access to all processes on your system running under that UID. Configure Apache to run with its own user and group IDs.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># groupadd apache
# useradd -c &quot;Apache Server&quot; -d /dev/null -g apache -s /bin/false apache&lt;/code&gt;
</pre></div>
</div>
<p>Create the jail as a mini-version of the Linux filesystem in a (for example) separate partition mounted as <code class="docutils literal notranslate"><span class="pre">/chroot</span></code>, with Apache under a directory named httpd.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># mkdir /chroot/httpd
# mkdir /chroot/httpd/dev
# mkdir /chroot/httpd/lib
# mkdir /chroot/httpd/etc
# mkdir -p /chroot/httpd/usr/sbin
# mkdir /chroot/httpd/usr/lib
# mkdir /chroot/httpd/usr/libexec
# mkdir -p /chroot/httpd/var/run
# mkdir -p /chroot/httpd/var/log/apache
# mkdir -p /chroot/httpd/home/httpd
</pre></div>
</div>
<p>Set permissions on the directory structure (for example)</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># chown -R root /chroot/httpd
# chmod -R 0755 /chroot/httpd
# chmod 750 /chroot/httpd/var/log/apache/
</pre></div>
</div>
<p>When Apache is running in the chroot jail, it sees the <code class="docutils literal notranslate"><span class="pre">/chroot/httpd</span></code> directory as the equivalent of <code class="docutils literal notranslate"><span class="pre">/</span></code>. Meaning it cannot access <code class="docutils literal notranslate"><span class="pre">/dev/null</span></code> or <code class="docutils literal notranslate"><span class="pre">/var/log</span></code> on the normal filesystem. Create the null device</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># mknod  /chroot/httpd/dev/null c 1 3
# chown root.sys /chroot/httpd/dev/null 
# chmod 666 /chroot/httpd/dev/null
</pre></div>
</div>
<p>Shut down Apache, run <code class="docutils literal notranslate"><span class="pre">killall</span> <span class="pre">httpd</span></code>, and copy the necessary files</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cp -r /etc/apache /chroot/httpd/etc/    /*configuration files*/
# cp -r /home/httpd/html /chroot/httpd/home/httpd/    /*Apache DocumentRoot*/
# cp -r /home/httpd/cgi-bin /chroot/httpd/home/httpd/    /*CGI scripts*/
# cp /usr/sbin/httpd /chroot/usr/sbin/    /*httpd binary*/
# cp /usr/sbin/apache* /chroot/usr/sbin/    /*Apache scripts*/
# cp -a /etc/ssl /chroot/httpd/etc/    /*if mod_ssl, the /etc/ssl directory and
its contents*/
# cp -r /usr/libexec/apache /chroot/httpd/usr/libexec/ /*modules from original install*/
</pre></div>
</div>
<p>Find libraries with</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># ldd /chroot/httpd/usr/sbin/httpd
/lib/libsafe.so.2 =&gt; /lib/libsafe.so.2 (0x40017000)
libm.so.6 =&gt; /lib/libm.so.6 (0x40037000)
libcrypt.so.1 =&gt; /lib/libcrypt.so.1 (0x40059000)
libdb.so.2 =&gt; /lib/libdb.so.2 (0x40086000)
libexpat.so.0 =&gt; /usr/lib/libexpat.so.0 (0x40096000)
libdl.so.2 =&gt; /lib/libdl.so.2 (0x400b6000)
libc.so.6 =&gt; /lib/libc.so.6 (0x400b9000)
/lib/ld-linux.so.2 =&gt; /lib/ld-linux.so.2 (0x40000000)
</pre></div>
</div>
<p>Copy libraries</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cp /lib/libsafe* /chroot/httpd/lib/
# cp /lib/libm* /chroot/httpd/lib/
# cp /lib/libcrypt* /chroot/httpd/lib/
# cp /lib/libdb* /chroot/httpd/lib/
# cp /usr/lib/libexpat* /chroot/httpd/usr/lib/
# cp /lib/libdl* /chroot/httpd/lib/
# cp /lib/libc* /chroot/httpd/lib/
# cp /lib/ld-* /chroot/httpd/lib/
</pre></div>
</div>
<p>Copy libraries for some standard networking functionality:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cp /lib/libnss_compat* /chroot/httpd/lib/
# cp /lib/libnss_dns* /chroot/httpd/lib/
# cp /lib/libnss_files* /chroot/httpd/lib/
# cp /lib/libnsl* /chroot/httpd/lib/
</pre></div>
</div>
<p>Edit the <code class="docutils literal notranslate"><span class="pre">/etc/passwd</span></code> and <code class="docutils literal notranslate"><span class="pre">/etc/group</span></code> files to contain only entries for the Apache user and group (see first step)</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/etc/passwd:
apache:x:12347:12348:Apache Server:/dev/null:/bin/false

/etc/group:
apache:x:12347:
</pre></div>
</div>
<p>Copy network configuration files:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cp /etc/hosts /chroot/httpd/etc/
# cp /etc/host.conf /chroot/httpd/etc/
# cp /etc/resolv.conf /chroot/httpd/etc/
# cp /etc/nsswitch.conf /chroot/httpd/etc/
</pre></div>
</div>
<p>And write protect the configuration files:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># chattr +i /chroot/httpd/etc/hosts
# chattr +i /chroot/httpd/etc/host.conf
# chattr +i /chroot/httpd/etc/resolv.conf
# chattr +i /chroot/httpd/etc/nsswitch.conf
# chattr +i /chroot/httpd/etc/passwd
# chattr +i /chroot/httpd/etc/group
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">localtime</span></code> is a symlink to a file in <code class="docutils literal notranslate"><span class="pre">/usr/share/zoneinfo</span></code>. Find out which file to copy and copy it.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># ls -l /etc/localtime
lrwxrwxrwx 1 root root 32 Apr  1 15:48 /etc/localtime -&gt; /usr/share/zoneinfo/Europe/Paris
# cp /usr/share/zoneinfo/Europe/Paris /chroot/httpd/etc/localtime
</pre></div>
</div>
<p>Syslogd monitors log files only in <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>. The chrooted httpd daemon will write its logs to <code class="docutils literal notranslate"><span class="pre">/chroot/httpd/var/log</span></code>. Syslogd needs to monitor this directory too. Edit the used startup script, <code class="docutils literal notranslate"><span class="pre">/etc/rc.d/rc.syslog</span></code> or <code class="docutils literal notranslate"><span class="pre">/etc/rc.d/init.d/syslog</span></code>, depending. For <code class="docutils literal notranslate"><span class="pre">/etc/rc.d/rc.syslog</span></code> change <code class="docutils literal notranslate"><span class="pre">/usr/sbin/syslogd</span></code> to <code class="docutils literal notranslate"><span class="pre">/usr/sbin/syslogd</span> <span class="pre">-m</span> <span class="pre">0</span> <span class="pre">-a</span> <span class="pre">/chroot/httpd/var/log</span></code></p>
<p>Create the necessary log files and write-protect them too.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># touch /chroot/httpd/var/log/apache/access_log
# touch /chroot/httpd/var/log/apache/error_log
# chmod 600 /chroot/httpd/var/log/apache/*
# chattr +a /chroot/httpd/var/log/apache/*
</pre></div>
</div>
<p>Change the httpd startup script to run the chrooted httpd. Depending, open up <code class="docutils literal notranslate"><span class="pre">/etc/rc.d/rc.httpd</span></code> or <code class="docutils literal notranslate"><span class="pre">/etc/rc.d/init.d/httpd</span></code> and change the command that starts the httpd daemon to read <code class="docutils literal notranslate"><span class="pre">/usr/sbin/chroot</span> <span class="pre">/chroot/httpd/</span> <span class="pre">/usr/sbin/httpd</span></code>.</p>
<p>Shut down the httpd daemon and restart the syslog daemon: <code class="docutils literal notranslate"><span class="pre">/etc/rc.d/rc.syslog</span> <span class="pre">restart</span></code> (or <code class="docutils literal notranslate"><span class="pre">/etc/rc.d/init.d/syslog</span></code> restart).</p>
<p>Start the chrooted version of Apache with <code class="docutils literal notranslate"><span class="pre">/etc/rc.d/rc.httpd</span> <span class="pre">start</span></code> (or <code class="docutils literal notranslate"><span class="pre">/etc/rc.d/init.d/httpd</span> <span class="pre">start</span></code>).</p>
<p>Check the daemon is running on the host with the command</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ps -aux | grep httpd
</pre></div>
</div>
<p>Take the process number from the output of <code class="docutils literal notranslate"><span class="pre">ps</span></code> and run <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-l</span> <span class="pre">/proc/PROC_NUMBER/root/</span></code> to see the structure of <code class="docutils literal notranslate"><span class="pre">/chroot/httpd</span></code></p>
<p>For troubleshooting, use <code class="docutils literal notranslate"><span class="pre">strace</span></code>. Redirecting output of strace to a file named httpd.strace gives an idea of where the problem lies</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># strace chroot /chroot/httpd /usr/sbin/httpd 2&gt; httpd.strace
</pre></div>
</div>
<section id="the-automated-way-for-apache">
<h2>The automated way for Apache<a class="headerlink" href="#the-automated-way-for-apache" title="Permalink to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">mod_chroot</span></code> allows for <a class="reference external" href="https://github.com/ZenProjects/Apache-mod-chroot">running Apache in a chroot jail with no additional files</a>. The <code class="docutils literal notranslate"><span class="pre">chroot()</span></code> system call is performed at the end of startup procedure - when all libraries are loaded and log files open. As of Apache 2.2.10 mod_chroot is installed in httpd by default, all that needs done is referencing ChrootDir in <code class="docutils literal notranslate"><span class="pre">/etc/httpd/conf/httpd.conf</span></code>.</p>
<p>The apache module <a class="reference external" href="https://httpd.apache.org/docs/2.4/mod/mod_unixd.html">mod_unixd</a> offers the chroot function in Apache 2.4, is part of the Apache core modules and is compiled statically into the Apache binary.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="README.html" class="btn btn-neutral float-left" title="Apache" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Disable-SSI-and-CGI-execution.html" class="btn btn-neutral float-right" title="Disable SSI and CGI execution" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
        <a href="https://unseen-uni.netlify.app/">Unseen University</a>, 2022

  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script> 

</body>
</html>